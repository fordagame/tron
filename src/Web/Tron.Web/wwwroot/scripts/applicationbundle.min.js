var __extends,Tron;(function(n){var t=function(){function t(n){this.basePath=n}return t.prototype.loadLanguageResource=function(t,i,r){n.app.ajax(this.basePath+"/"+t+"."+i+".js?ver="+version,{method:"Get",success:function(i){eval(i);r(t,n.Resources[t])}})},t}();n.ResourceLoader=t})(Tron||(Tron={})),function(n){var u=function(){function n(){}return n.Resource="ResourceResolver",n.Template="TemplateResolver",n}(),t,i,r;n.ResolverTypes=u;t=function(){function n(){}return n}();n.Dependency=t;i=function(){function t(){}return t.prototype.resolve=function(t,i){var r=t.resourceName;n.app.localization.isResourceLoaded(r)?i():n.app.localization.loadResource(r,i)},t}();n.ResourceResolver=i;r=function(){function t(){}return t.prototype.resolve=function(t,i){n.app.templates.loadTemplates(i)},t}();n.TemplateResolver=r}(Tron||(Tron={})),function(n){Handlebars.registerHelper("translate",function(t,i){return n.app.localization.translate(t,i)})}(Tron||(Tron={})),function(n){var t=function(){function n(){}return n.prototype.setCookie=function(n,t,i){var r=new Date,u;r.setTime(r.getTime()+i*864e5);u="expires="+r.toUTCString();document.cookie=n+"="+t+";"+u+";path=/"},n.prototype.getCookie=function(n){for(var t,r=n+"=",u=document.cookie.split(";"),i=0;i<u.length;i++){for(t=u[i];t.charAt(0)==" ";)t=t.substring(1);if(t.indexOf(r)==0)return t.substring(r.length,t.length)}return""},n}();n.CookieService=t}(Tron||(Tron={})),function(n){var t=function(){function t(n){this.dependencyLoader=n;this.dependencies=[]}return t.prototype.addResourceDepndency=function(t){var i=new n.Dependency;i.name=n.ResolverTypes.Resource;i.options={resourceName:t};this.dependencies.push(i)},t.prototype.loadTemplateDependency=function(){var t=new n.Dependency;t.name=n.ResolverTypes.Template;t.options={};this.dependencies.push(t)},t.prototype.executeDependencies=function(n){this.dependencyLoader.require(this.dependencies,n)},t.prototype.clear=function(){this.dependencies=[]},t}();n.DependencyService=t}(Tron||(Tron={})),function(n){var t=function(){function n(){}return n.Bulgarian=0,n.supportedLanguages=["bg"],n}(),i,r,u;n.SupportedLanguages=t,function(n){n[n.FullData=1]="FullData";n[n.UpdateSubscribe=2]="UpdateSubscribe";n[n.UpdateUnsubscribe=3]="UpdateUnsubscribe";n[n.UpdateUnsubscribeAllSimilar=4]="UpdateUnsubscribeAllSimilar"}(i=n.Commands||(n.Commands={})),function(n){n[n.Messages=1]="Messages"}(r=n.DataProviders||(n.DataProviders={})),function(n){n[n.Up=1]="Up";n[n.Right=2]="Right";n[n.Down=3]="Down";n[n.Left=4]="Left"}(u=n.TronGameDirection||(n.TronGameDirection={}))}(Tron||(Tron={})),function(n){function e(n,t){history.pushState(null,n,window.location.href);var i=document.getElementById("container");h(i);i.innerHTML=r.getContainerPageTemplate(n,t);s(i,t)}function s(t,i){o(t).forEach(function(t){var r=t.dataset.module,u=t.id;n.app.start(r,{root:t,instanceId:u,parameters:i})})}function h(t){o(t).forEach(function(t){var i=t.dataset.module,r=t.id;n.app.stop(i,r)})}function o(n){for(var i=[],r=n.querySelectorAll("[data-module]"),t=0,u=r.length;t<u;t++)i.push(r[t]);return i}function c(t){var t,i,r;if(!t)return"bg";for(t=t.substr(4,2),i=0;i<n.SupportedLanguages.supportedLanguages.length;i++)if(r=n.SupportedLanguages.supportedLanguages[i],r==t)return t;return"bg"}var r,u,f,t,i;n.app=dcore.createOne();n.app.useRouting();n.app.useMVP();n.app.useMVPExtended();n.app.useServices();n.app.useAjax();n.app.useWebSocket();u=new n.CookieService;f=u.getCookie(".AspNetCore.Culture");n.app.useLocalization(new n.ResourceLoader("/localization"),c(f));n.app.useTemplateResolver(new dcore.plugins.templates.TemplateResolver(Handlebars.templates,function(n){return n+".html"}));t=[];t[n.ResolverTypes.Resource]=new n.ResourceResolver;t[n.ResolverTypes.Template]=new n.TemplateResolver;n.app.useDependencyLoader(t);i=new n.DependencyService(n.app.dependency);i.addResourceDepndency("application");i.loadTemplateDependency();i.executeDependencies(function(){n.app.run(function(){var t,i;n.app.routing.register("/games",function(){return e("games",[])}).register("/tron/{id}",function(n){return e("tron",{gameId:n.id})}).defaultUrl="games";n.Resources=[];t=new n.ModulesConfig;t.init(n.app);i=new n.ServiceConfig;i.init(n.app);r=new n.PagesConfig;r.init(n.app);n.app.websocket.init("")})})}(Tron||(Tron={})),function(n){var t=function(){function t(){}return t.prototype.init=function(t){t.register("GamesModule",function(t){return new n.GamesModule(t)}).register("TronModule",function(t){return new n.TronModule(t)})},t}();n.ModulesConfig=t}(Tron||(Tron={})),function(n){var t=function(){function t(){}return t.prototype.init=function(t){var i=this;this.webSocket||(this.webSocket=new n.WebSocketService(t));t.services.add("cookies",function(){return new n.CookieService}).add("dependency",function(){return new n.DependencyService(n.app.dependency)}).add("websocket",function(){return i.webSocket}).add("game",function(){return new n.GameService}).add("users",function(){return new n.UsersService(t)})},t}();n.ServiceConfig=t}(Tron||(Tron={})),function(n){var t=function(){function n(){this.container=[]}return n.prototype.init=function(n){this.app=n;this.container.games="GamesPage";this.container.tron="TronPage"},n.prototype.getContainerPageTemplate=function(n){var t=this.container[n];return t?this.app.templates.getTemplate(this.container[n])(null):""},n}();n.PagesConfig=t}(Tron||(Tron={})),function(n){var t=function(){function t(n){this.serviceUrl="";this.serviceUrl=n;t.successFunc||(t.successFunc=[],t.resultCache=[])}return t.prototype.setTimeoutfunc=function(){return""},t.prototype.getData=function(i,r,u){var f=this.getKey(i),e;if(t.resultCache[f]){u(r(t.resultCache[f]));return}t.successFunc[f]||(e=this,n.app.ajax(e.url(i),{method:"Get",converter:function(n){return n},success:e.success.bind(e,f),error:function(n){console.info("Error ocur in getData!");console.info(n)}}));this.addObj(f,r,u)},t.prototype.postData=function(i,r,u,f,e){if(i=i+this.url(r),t.resultCache[i]){f(u(t.resultCache[i]));return}if(!t.successFunc[i]){var o=this;n.app.ajax(o.url(r),{method:"Post",data:e,converter:function(n){return n},success:o.success.bind(o,i),error:function(n){console.info("Error ocur in postData!");console.info(n)}})}this.addObj(i,u,f)},t.prototype.url=function(n){return this.serviceUrl+"/"+n},t.prototype.getKey=function(n){return this.serviceUrl+"/"+n},t.prototype.addObj=function(i,r,u){t.successFunc[i]?t.successFunc[i].push({success:u,convert:r}):(t.successFunc[i]=new n.List,t.successFunc[i].push({success:u,convert:r}))},t.prototype.success=function(n,i){var u,r,f;for(this.addResultCache(n,i),u=t.successFunc[n],t.successFunc[n]=null,r=0;r<u.objects.length;r++)f=u.objects[r],f.success(f.convert(i))},t.prototype.addResultCache=function(n,i){t.resultCache[n]=i;setTimeout(function(){delete t.resultCache[n]},2e3)},t.prototype.GeneralErrorHandle=function(n){console.info("Error ocur: "+n)},t}();n.BaseService=t}(Tron||(Tron={})),function(n){var t=function(){function t(n){this.app=n;this.app.subscribe(["WebSocketDataReceived"],this.onWebSocketMessage.bind(this));t.subscribers||(t.subscribers=[])}return t.prototype.onWebSocketMessage=function(i,r){var e=JSON.parse(r.data),u=new n.WebSocketMessage,f;if(u.deserialize(e),t.subscribers[u.type])for(f=0;f<t.subscribers[u.type].objects.length;f++)t.subscribers[u.type].objects[f](u)},t.prototype.addPlayer=function(n,t){this.app.websocket.send(JSON.stringify({MessageType:"addPlayer",gameId:n,name:t}))},t.prototype.updateGameState=function(n,t){this.app.websocket.send(JSON.stringify({MessageType:"tronDirectionUpdate",gameId:n,direction:t}))},t.prototype.subscribeForMessage=function(i,r){t.subscribers[i]||(t.subscribers[i]=new n.List);t.subscribers[i].push(r)},t.prototype.unsubscribeForMessage=function(n,i){if(t.subscribers[n])for(var r=0;r<t.subscribers[n].objects.length;r++)t.subscribers[n].objects[r]==i&&t.subscribers[n].objects.splice(r,1)},t}();n.WebSocketService=t}(Tron||(Tron={})),function(n){var t=function(){function t(n){this.app=n}return t.prototype.getUser=function(){if(!t.user){var i=this.app.services.get("cookies"),r=i.getCookie("name"),u=parseInt(i.getCookie("id"));t.user=new n.User;t.user.name=r;t.user.id=u}return t.user},t}();n.UsersService=t}(Tron||(Tron={}));__extends=this&&this.__extends||function(){var n=function(t,i){return n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(n,t){n.__proto__=t}||function(n,t){for(var i in t)t.hasOwnProperty(i)&&(n[i]=t[i])},n(t,i)};return function(t,i){function r(){this.constructor=t}n(t,i);t.prototype=i===null?Object.create(i):(r.prototype=i.prototype,new r)}}(),function(n){var t=function(n){function t(){return n.call(this,"api/game")||this}return __extends(t,n),t.prototype.createGame=function(n,t){var i=JSON.stringify({options:n});this.postData(i,"creategame",function(n){return n},t,i)},t}(n.BaseService);n.GameService=t}(Tron||(Tron={})),function(n){var t=function(){function n(n){this.sandbox=n;this.subscriptionTokens=[]}return n.prototype.init=function(){},n.prototype.destroy=function(){this.removeEvents()},n.prototype.addEventToken=function(n){this.subscriptionTokens.push(n)},n.prototype.removeEvents=function(){var n,t;for(n in this.subscriptionTokens)t=this.subscriptionTokens[n],t.destroy()},n}();n.BaseModule=t}(Tron||(Tron={}));__extends=this&&this.__extends||function(){var n=function(t,i){return n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(n,t){n.__proto__=t}||function(n,t){for(var i in t)t.hasOwnProperty(i)&&(n[i]=t[i])},n(t,i)};return function(t,i){function r(){this.constructor=t}n(t,i);t.prototype=i===null?Object.create(i):(r.prototype=i.prototype,new r)}}(),function(n){var t=function(t){function i(n){return t.call(this,n)||this}return __extends(i,t),i.prototype.init=function(n){t.prototype.init.call(this,n);var i=this.sandbox.getService("dependency");i.addResourceDepndency("application");i.addResourceDepndency("games");i.executeDependencies(this.initRequirements.bind(this,n))},i.prototype.initRequirements=function(t){this.presenter=new n.GamesPresenter(this.sandbox,new n.GamesView(this.sandbox.getTemplate("GamesModule")));this.presenter.view.presenter=this.presenter;this.root=t.root;this.root.innerHTML="";this.root.appendChild(this.presenter.render())},i.prototype.destroy=function(){t.prototype.destroy.call(this);this.presenter.destroy()},i}(n.BaseModule);n.GamesModule=t}(Tron||(Tron={}));__extends=this&&this.__extends||function(){var n=function(t,i){return n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(n,t){n.__proto__=t}||function(n,t){for(var i in t)t.hasOwnProperty(i)&&(n[i]=t[i])},n(t,i)};return function(t,i){function r(){this.constructor=t}n(t,i);t.prototype=i===null?Object.create(i):(r.prototype=i.prototype,new r)}}(),function(n){var t=function(t){function i(n){return t.call(this,n)||this}return __extends(i,t),i.prototype.init=function(n){t.prototype.init.call(this,n);var i=this.sandbox.getService("dependency");i.addResourceDepndency("application");i.addResourceDepndency("tron");i.executeDependencies(this.initRequirements.bind(this,n))},i.prototype.initRequirements=function(t){var u,i,f,e,r;this.presenter=new n.TronPresenter(this.sandbox,new n.TronView(this.sandbox.getTemplate("TronModule")));this.presenter.view.presenter=this.presenter;this.presenter.gameId=this.gameId=t.parameters.gameId;u=this.sandbox.getService("users");i=this.sandbox.getService("websocket");this.wsSubscriptions=[];f=this.receivePlayerDataUpdate.bind(this);this.wsSubscriptions.PlayerData=f;e=this.receiveGameDataUpdate.bind(this);this.wsSubscriptions.GameUpdate=e;for(r in this.wsSubscriptions)i.subscribeForMessage(r,this.wsSubscriptions[r]);i.addPlayer(this.gameId,u.getUser().name);this.root=t.root;this.root.innerHTML="";this.root.appendChild(this.presenter.render())},i.prototype.receivePlayerDataUpdate=function(t){var i=new n.TronPlayerUpdate;i.deserialize(t.data);this.presenter.updateGameData(i)},i.prototype.receiveGameDataUpdate=function(t){var i=new n.TronGameUpdate;i.deserialize(t.data);this.presenter.updateGameState(i)},i.prototype.destroy=function(){var i,n;t.prototype.destroy.call(this);this.presenter.destroy();i=this.sandbox.getService("websocket");for(n in this.wsSubscriptions)i.unsubscribeForMessage(n,this.wsSubscriptions[n])},i}(n.BaseModule);n.TronModule=t}(Tron||(Tron={}));__extends=this&&this.__extends||function(){var n=function(t,i){return n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(n,t){n.__proto__=t}||function(n,t){for(var i in t)t.hasOwnProperty(i)&&(n[i]=t[i])},n(t,i)};return function(t,i){function r(){this.constructor=t}n(t,i);t.prototype=i===null?Object.create(i):(r.prototype=i.prototype,new r)}}(),function(n){var t=function(n){function t(t){var i=n.call(this,document.createElement("div"),t)||this;return i.addEventListener({type:"click",selector:"#create_tron_game",listener:i.create_tron_game}),i}return __extends(t,n),t.prototype.render=function(t){var i=n.prototype.render.call(this,t),r=this.root.querySelector("#playerName");return r.innerHTML=this.presenter.getName(),i},t.prototype.create_tron_game=function(){var n=this.root.querySelector("#numberOfPlayers");this.presenter.createGame(parseInt(n.value))},t}(n.app.mvpExt.baseView);n.GamesView=t}(Tron||(Tron={}));__extends=this&&this.__extends||function(){var n=function(t,i){return n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(n,t){n.__proto__=t}||function(n,t){for(var i in t)t.hasOwnProperty(i)&&(n[i]=t[i])},n(t,i)};return function(t,i){function r(){this.constructor=t}n(t,i);t.prototype=i===null?Object.create(i):(r.prototype=i.prototype,new r)}}(),function(n){var t=function(t){function i(n){var i=t.call(this,document.createElement("div"),n)||this;return i.colors=["orange","blue","green","purple"],i.currentColors=["darkorange","darkblue","darkgreen","darkwhite"],i.keyHandler=i.handle_move.bind(i),document.addEventListener("keypress",i.keyHandler,!0),i}return __extends(i,t),i.prototype.render=function(n){return t.prototype.render.call(this,n)},i.prototype.handle_move=function(t){switch(t.which){case 100:this.presenter.updateDirection(n.TronGameDirection.Right);break;case 115:this.presenter.updateDirection(n.TronGameDirection.Down);break;case 97:this.presenter.updateDirection(n.TronGameDirection.Left);break;case 119:this.presenter.updateDirection(n.TronGameDirection.Up)}},i.prototype.drawInCanvas=function(n,t,i,r){var u=this.root.querySelector("#tron_game"),o=u.getContext("2d"),f,e;o.fillStyle=r?"red":this.colors[i];f=u.width/this.boardX;e=u.height/this.boardY;o.fillRect(n*f,t*e,f,e)},i.prototype.setGameData=function(n){this.boardX=n.boardx;this.boardY=n.boardy},i.prototype.updatePlayers=function(n){var r=this.root.querySelector("#activePlayers"),t,i;for(r.innerHTML="",t=0;t<n.length;t++)i=document.createElement("div"),r.appendChild(i),i.innerHTML=n[t].name,i.style.color=this.colors[n[t].position-1]},i.prototype.destroy=function(){document.removeEventListener("keypress",this.keyHandler,!0);t.prototype.destroy.call(this)},i}(n.app.mvpExt.baseView);n.TronView=t}(Tron||(Tron={}));__extends=this&&this.__extends||function(){var n=function(t,i){return n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(n,t){n.__proto__=t}||function(n,t){for(var i in t)t.hasOwnProperty(i)&&(n[i]=t[i])},n(t,i)};return function(t,i){function r(){this.constructor=t}n(t,i);t.prototype=i===null?Object.create(i):(r.prototype=i.prototype,new r)}}(),function(n){var t=function(t){function i(n,i){var r=t.call(this,i)||this;return r.sandbox=n,r}return __extends(i,t),i.prototype.getName=function(){var n=this.sandbox.getService("users").getUser();return n.name},i.prototype.createGame=function(t){var i=new n.GameOptions,r;i.numberOfPlayers=t;i.type=n.GameType.Tron;r=this.sandbox.getService("game");r.createGame(i,this.gameCreated.bind(this))},i.prototype.gameCreated=function(n){window.location.hash="#tron/"+n},i}(dcore.plugins.mvp.Presenter);n.GamesPresenter=t}(Tron||(Tron={}));__extends=this&&this.__extends||function(){var n=function(t,i){return n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(n,t){n.__proto__=t}||function(n,t){for(var i in t)t.hasOwnProperty(i)&&(n[i]=t[i])},n(t,i)};return function(t,i){function r(){this.constructor=t}n(t,i);t.prototype=i===null?Object.create(i):(r.prototype=i.prototype,new r)}}(),function(n){var t=function(t){function i(n,i){var r=t.call(this,i)||this;return r.sandbox=n,r.players=[],r}return __extends(i,t),i.prototype.destroy=function(){this.view.destroy()},i.prototype.updateDirection=function(n){var t=this.sandbox.getService("websocket");t.updateGameState(this.gameId,n)},i.prototype.updateGameData=function(n){this.playerGameData=n;this.view.setGameData(n)},i.prototype.updateGameState=function(t){var u,r,i;if(t.state==n.GameState.WaitingForPlayers&&(u=this.players.length,u!=t.players.length&&(this.players=t.players,this.view.updatePlayers(this.players))),t.state>n.GameState.WaitingForPlayers){for(r=[],i=0;i<this.players.length;i++)r[this.players[i].id]=this.players[i].position;for(i=0;i<t.newCoordinates.length;i++)this.view.drawInCanvas(t.lastCoordinates[i].x,t.lastCoordinates[i].y,r[t.lastCoordinates[i].id]-1,!1);for(i=0;i<t.newCoordinates.length;i++)console.info(t.newCoordinates[i]),this.view.drawInCanvas(t.newCoordinates[i].x,t.newCoordinates[i].y,r[t.newCoordinates[i].id]-1,!0)}t.state==n.GameState.Ended&&alert(t.winnerName)},i}(dcore.plugins.mvp.Presenter);n.TronPresenter=t}(Tron||(Tron={}));__extends=this&&this.__extends||function(){var n=function(t,i){return n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(n,t){n.__proto__=t}||function(n,t){for(var i in t)t.hasOwnProperty(i)&&(n[i]=t[i])},n(t,i)};return function(t,i){function r(){this.constructor=t}n(t,i);t.prototype=i===null?Object.create(i):(r.prototype=i.prototype,new r)}}(),function(n){var t=function(n){function t(t){t===void 0&&(t=[]);var i=n.call(this)||this;return t&&(i.objects=t),i}return __extends(t,n),t.prototype.pushRange=function(n){this.objects=this.objects.concat(n.objects)},t.prototype.push=function(n){this.objects.push(n)},t.prototype.pop=function(){return this.objects.pop()},t}(n.app.mvp.Model);n.List=t}(Tron||(Tron={})),function(n){var t=function(){function n(){}return n}();n.User=t}(Tron||(Tron={})),function(n){var i,t;(function(n){n[n.Tron=1]="Tron"})(i=n.GameType||(n.GameType={}));t=function(){function n(){}return n}();n.GameOptions=t}(Tron||(Tron={})),function(n){var t=function(){function n(){}return n.prototype.deserialize=function(n){this.type=n.type;this.data=n.data},n}();n.WebSocketMessage=t}(Tron||(Tron={})),function(n){var t=function(){function n(){}return n.prototype.deserialize=function(n){this.x=n.x;this.y=n.y;this.id=n.id},n}();n.TronCoordinate=t}(Tron||(Tron={})),function(n){var t=function(){function n(){}return n.prototype.deserialize=function(n){this.x=n.x;this.y=n.y;this.id=n.id;this.alive=n.alive;this.position=n.position;this.name=n.name},n}();n.TronPlayer=t}(Tron||(Tron={})),function(n){var i,t;(function(n){n[n.PlayerAdded=1]="PlayerAdded";n[n.GameIsFull=2]="GameIsFull"})(i=n.AddPlayerState||(n.AddPlayerState={}));t=function(){function n(){}return n.prototype.deserialize=function(n){this.id=n.id;this.boardx=n.boardx;this.boardy=n.boardy;this.numberOfPlayers=n.numberOfPlayers;this.state=n.state},n}();n.TronPlayerUpdate=t}(Tron||(Tron={})),function(n){var i,t;(function(n){n[n.WaitingForPlayers=1]="WaitingForPlayers";n[n.Started=2]="Started";n[n.Ended=3]="Ended"})(i=n.GameState||(n.GameState={}));t=function(){function t(){this.players=[];this.newCoordinates=[];this.lastCoordinates=[]}return t.prototype.deserialize=function(t){var u,i,r;if(this.winnerName=t.winnerName,this.state=t.state,this.players=[],t.players)for(i=0;i<t.players.length;i++)u=new n.TronPlayer,u.deserialize(t.players[i]),this.players[i]=u;if(this.lastCoordinates=[],t.lastCoordinates)for(i=0;i<t.lastCoordinates.length;i++)r=new n.TronCoordinate,r.deserialize(t.lastCoordinates[i]),this.lastCoordinates[i]=r;if(this.newCoordinates=[],t.newCoordinates)for(i=0;i<t.newCoordinates.length;i++)r=new n.TronCoordinate,r.deserialize(t.newCoordinates[i]),this.newCoordinates[i]=r},t}();n.TronGameUpdate=t}(Tron||(Tron={}));